(function(){"use strict";const ot={userStartAge:65,spouseUserAgeStart:65,basicFullAnnualYen:78e4,basicReduction:.9,earlyReduction:void 0,pensionDataAge:44,userKoseiAccruedAtDataAgeAnnualYen:1e6,userKoseiFutureFactorAnnualYenPerYear:42e3,includeSpouse:!0};function gt(t){const e=Number(t);if(!Number.isFinite(e)||e===65)return 1;if(e<65){const o=Math.max(0,Math.round((65-e)*12));return Math.max(0,1-o*.004)}const n=Math.min(e,75);return 1+Math.max(0,Math.round((n-65)*12))*.007}function at(t,e,n=ot){let s=0;const{userStartAge:o,spouseUserAgeStart:i,basicFullAnnualYen:l,basicReduction:r,earlyReduction:m,pensionDataAge:c,userKoseiAccruedAtDataAgeAnnualYen:a,userKoseiFutureFactorAnnualYenPerYear:f,includeSpouse:u}=n,h=m??gt(o);if(t>=o){const M=l*r*h,g=Math.min(60,e),A=Math.max(0,g-c),p=a+A*f;s+=M+p*h}return u&&t>=i&&(s+=l),Math.round(s/12)}const Y=12,O=100,At=80;function xt({monthlyReturn:t,monthlyInflation:e,remainingMonths:n,taxRate:s,includeTax:o,currentAgeInSimulation:i,includePension:l=!0,withdrawalRate:r=.04,pensionConfig:m,postFireFirstYearExtraExpense:c,m:a,precalculatedBaseExpenses:f,precalculatedExtraExpenses:u}){if(n<=0)return 0;const h=t,M=e,g=r/12,A=o?s:0;let p=0;for(let d=n-1;d>=0;d--){const w=i+d/12,y=l?at(w,i,m):0,b=f[a+d]+u[a+d];let R=0;d<12&&(R=c/12*Math.pow(1+M,a+d));const E=b+R,C=Math.max(0,E-y),_=p/(1+h)+C/(1-A),q=(p/(1+h)-y/(1-A))/(1-g/(1-A));p=Math.max(_,q)}return Math.max(0,p)}function rt(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`}function yt({baseMonthlyExpense:t,monthlyInflationRate:e,monthIndex:n,simulationStartDate:s,mortgageMonthlyPayment:o,mortgagePayoffDate:i,lifestyleReductionFactor:l=1,independenceMonthKey:r,independenceMonthKeys:m=[],householdChildrenCount:c=0}){const a=o||0,f=Math.max(0,t-a),u=new Date(s);u.setMonth(u.getMonth()+n);const h=rt(u),g=(m.length>0?m:r?[r]:[]).filter(d=>h>=d).length,A=Rt({householdChildrenCount:c,independentChildrenCount:g,lifestyleReductionFactor:l}),p=f*A*Math.pow(1+e,n);return!a||!i?p+a:h>i?p:p+a}function Rt({householdChildrenCount:t,independentChildrenCount:e,lifestyleReductionFactor:n}){return t<=1?e>0?n:1:t===2?[1,.85,.7][Math.min(e,2)]:[1,.9,.8,.65][Math.min(e,3)]}function Et(t=[],e=24){return Array.isArray(t)?t.map(n=>{const s=new Date(n);if(isNaN(s.getTime()))return null;const o=new Date(s.getFullYear()+e,3,1);return rt(o)}).filter(Boolean).sort():[]}function H(t){if(!t)return H({});const e=t.monthlyExpense??(t.monthlyExpenses?t.monthlyExpenses/12:0),n=Number(t.currentAge||40),s=Number(t.simulationEndAge??O),o=Math.max(At,Math.ceil(n)),i=Math.min(O,Math.max(o,Number.isFinite(s)?s:O));return{initialAssets:Number(t.initialAssets??0),riskAssets:Number(t.riskAssets??0),annualReturnRate:Number(t.annualReturnRate??0),monthlyExpense:Number(e),monthlyIncome:Number(t.monthlyIncome??0),currentAge:n,includeInflation:!!t.includeInflation,inflationRate:Number(t.inflationRate??.02),includeTax:!!t.includeTax,taxRate:Number(t.taxRate??.20315),withdrawalRate:Number(t.withdrawalRate??.04),mortgageMonthlyPayment:Number(t.mortgageMonthlyPayment??0),mortgagePayoffDate:t.mortgagePayoffDate||null,postFireExtraExpense:Number(t.postFireExtraExpense??0),postFireFirstYearExtraExpense:Number(t.postFireFirstYearExtraExpense??0),retirementLumpSumAtFire:Number(t.retirementLumpSumAtFire??5e6),includePension:!!t.includePension,monthlyInvestment:Number(t.monthlyInvestment??0),maxMonths:Number(t.maxMonths??1200),pensionConfig:t.pensionConfig||ot,dependentBirthDate:t.dependentBirthDate||null,dependentBirthDates:Array.isArray(t.dependentBirthDates)?t.dependentBirthDates.filter(Boolean).slice(0,3):t.dependentBirthDate?[t.dependentBirthDate]:[],independenceAge:t.independenceAge||24,householdType:t.householdType||"single",simulationEndAge:i}}function W(t,{recordMonthly:e=!1,fireMonth:n=-1,returnsArray:s=null,skipRequiredAssets:o=!1}={}){const{initialAssets:i,riskAssets:l,annualReturnRate:r,monthlyExpense:m,monthlyIncome:c,currentAge:a,maxMonths:f,includeInflation:u,inflationRate:h,includeTax:M,taxRate:g,withdrawalRate:A,mortgageMonthlyPayment:p,mortgagePayoffDate:d,postFireExtraExpense:w,postFireFirstYearExtraExpense:y,retirementLumpSumAtFire:b,includePension:R,monthlyInvestment:E,pensionConfig:C,dependentBirthDate:_,dependentBirthDates:q,independenceAge:j,householdType:U,simulationEndAge:F=O}=t,v=m,N=Math.pow(1+r,1/12)-1,P=Math.pow(1+(u?h:0),1/12)-1,S=(F-a)*Y,G=new Date,ct=St({dependentBirthDate:_,dependentBirthDates:q}),kt=Et(ct,j),Bt=U==="family"?ct.length:0;let D=l,K=l,I=i-l,k=n;const $=e?[]:null,ut=S,Yt=U==="family"?.8:1,{precalculatedBaseExpenses:ht,precalculatedExtraExpenses:mt}=It({simulationLimit:ut,monthlyExp:v,monthlyInflationRate:P,simulationStartDate:G,mortgageMonthlyPayment:p,mortgagePayoffDate:d,lifestyleReductionFactor:Yt,independenceMonthKeys:kt,householdChildrenCount:Bt,postFireExtraExpense:w});for(let x=0;x<=ut;x++){const et=a+x/12,Ct=Math.max(0,S-x);x===k&&(I+=b);let ft=0;k!==-1&&x>=k&&x<k+12&&(ft=y/12*Math.pow(1+P,x));const Mt=Math.max(0,I+D),J=k!==-1&&x>=k,_t=k===-1?F:a+k/12,dt=R?at(et,_t,C):0,pt=J?0:c,Q=ht[x]+(J?mt[x]:0)+ft,nt=pt+dt;if(e&&x<=f){const B=o?0:xt({monthlyReturn:N,monthlyInflation:P,remainingMonths:Ct,taxRate:g,includeTax:M,currentAgeInSimulation:et,includePension:R,withdrawalRate:A,pensionConfig:C,postFireFirstYearExtraExpense:y,m:x,precalculatedBaseExpenses:ht,precalculatedExtraExpenses:mt});$.push({month:x,age:et,assets:Mt,riskAssets:D,cashAssets:I,requiredAssets:B,isFire:J,income:pt,pension:dt,expenses:Q,investmentGain:0,withdrawal:0})}if(x===S)break;let X=0,Z=0,st=0;const Lt=s[x];if(J){const B=Mt*A/12,L=Math.max(0,Q-nt),V=Math.max(L,B),T=Math.min(I,V),qt=V-T,tt=lt({neededNetAmount:qt,currentRisk:D,currentCostBasis:K,includeTax:M,taxRate:g});D=tt.nextRisk,K=tt.nextCostBasis,I+=nt+tt.actualNetFromRisk-Q,X=T+tt.grossFromRisk}else{const B=nt-Q,L=I+B;if(L<0){const V=Math.abs(L),T=lt({neededNetAmount:V,currentRisk:D,currentCostBasis:K,includeTax:M,taxRate:g});D=T.nextRisk,K=T.nextCostBasis,I=L+T.actualNetFromRisk,X=T.actualNetFromRisk>0?T.grossFromRisk:0}else Z=Math.min(E,L),I=L-Z,D+=Z,K+=Z,X=0}if(st=D*Lt,D+=st,e&&x<=f){const B=$[$.length-1];B&&(B.investmentGain=st,B.withdrawal=X)}}const Tt=I+D>=0;return{fireReachedMonth:k,monthlyData:$,survived:Tt,finalAssets:I+D}}function Ft(t,e=null){const{currentAge:n,maxMonths:s,simulationEndAge:o}=t,i=Math.min(s,(o-n)*Y);let l=-1;for(let r=0;r<=i;r+=Y)if(W(t,{fireMonth:r,returnsArray:e}).survived){l=r;break}if(l!==-1){let r=Math.max(0,l-11),m=l;for(;r<=m;){const c=Math.floor((r+m)/2);W(t,{fireMonth:c,returnsArray:e}).survived?(l=c,m=c-1):r=c+1}}return l}function wt(t,e={}){const n=H(t),{forceFireMonth:s=null,returnsArray:o=null,recordMonthly:i=!1}=e;let l=o;if(!l){const{currentAge:m,annualReturnRate:c,simulationEndAge:a}=n,f=(a-m)*Y,u=Math.pow(1+c,1/12)-1;l=Pt(f,u)}let r=s;return r===null&&(r=Ft(n,l)),W(n,{recordMonthly:i,fireMonth:r,returnsArray:l})}function bt(t){return function(){let e=t+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function Nt(t){let e=0,n=0;for(;e===0;)e=t();for(;n===0;)n=t();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*n)}function it(t,{trials:e=1e3,annualVolatility:n=.15,seed:s=123,forceFireMonth:o=null}={}){const i=H(t),r=wt(i,{forceFireMonth:o}).fireReachedMonth,m=Math.max(1,Math.floor(Number(e)||0)),c=Math.max(0,Number.isFinite(n)?n:0),a=bt(s),{currentAge:f,annualReturnRate:u,simulationEndAge:h}=i,M=(h-f)*Y,g=u,A=c,p=Math.log(1+g)-.5*Math.log(1+Math.pow(A/(1+g),2)),d=Math.log(1+Math.pow(A/(1+g),2)),w=p/12,y=Math.sqrt(d/12),b=[],R=[];let E=0;const C=Math.ceil(M/Y);for(let F=0;F<m;F++){const v=[];for(let S=0;S<=M;S++){const G=w+y*Nt(a);v.push(Math.exp(G)-1)}const N=W(i,{fireMonth:r,returnsArray:v,recordMonthly:!0,skipRequiredAssets:!0});b.push(N.finalAssets),N.survived&&E++;const P=[];for(let S=0;S<=C;S++){const G=S*Y;G<N.monthlyData.length?P.push(N.monthlyData[G].assets):P.push(N.monthlyData[N.monthlyData.length-1].assets)}R.push(P)}b.sort((F,v)=>F-v);const _=F=>z(b,F),q=[],j=[],U=[];for(let F=0;F<=C;F++){const v=R.map(N=>N[F]).sort((N,P)=>N-P);q.push(z(v,10)),j.push(z(v,50)),U.push(z(v,90))}return{successRate:E/m,p10:_(10),p50:_(50),p90:_(90),p10Path:q,p50Path:j,p90Path:U,trials:m,fireReachedMonth:r}}function Dt(t,e){const n=H(t),{trials:s=1e3,annualVolatility:o=.15,seed:i=123,targetSuccessRate:l=.8,simulationEndAge:r=100,currentAge:m=40}=e,c=Math.min(.99,Math.max(.01,l)),a=Math.max(0,Math.floor((r-m)*12)),f={trials:s,annualVolatility:o,seed:i},u=A=>it(n,{...f,forceFireMonth:A});let h=a,M=u(h);if(M.successRate<c)h=-1;else{const A=u(0);if(A.successRate>=c)h=0,M=A;else{let p=0,d=a;for(;p<d;){const w=Math.floor((p+d)/2),y=u(w);y.successRate>=c?(d=w,M=y):p=w+1}h=p,M=u(h)}}const g=vt(n,{...f,targetTerminalAssets:0,toleranceYen:5e5,minFireMonth:0,maxFireMonth:a});return{...M,targetSuccessRate:c,recommendedFireMonth:h,recommendedFireAge:h===-1?null:Math.floor(m+h/12),terminalDepletionPlan:g}}function vt(t,{trials:e=1e3,annualVolatility:n=.15,seed:s=123,targetTerminalAssets:o=0,toleranceYen:i=1e5,minFireMonth:l=0,maxFireMonth:r=null,maxIterations:m=18}={}){const c=H(t),a=Math.max(0,Math.floor((c.simulationEndAge-c.currentAge)*Y)),f=Math.max(0,Math.floor(Number(l)||0)),u=Math.min(a,Math.max(f,Math.floor(Number(r??a)||a))),h=b=>it(c,{trials:e,annualVolatility:n,seed:s,forceFireMonth:b}),M=h(f);if(M.p50>=o-i)return{recommendedFireMonth:f,p50TerminalAssets:M.p50,successRate:M.successRate,iterations:1,boundaryHit:"low",evaluation:M};const g=h(u);if(g.p50<o-i)return{recommendedFireMonth:u,p50TerminalAssets:g.p50,successRate:g.successRate,iterations:2,boundaryHit:"high",evaluation:g};let A=f,p=u,d=g,w=u,y=2;for(let b=0;b<m;b++){const R=Math.floor((A+p)/2),E=h(R);if(y+=1,Math.abs(E.p50-o)<Math.abs(d.p50-o)&&(d=E,w=R),Math.abs(E.p50-o)<=i)return{recommendedFireMonth:R,p50TerminalAssets:E.p50,successRate:E.successRate,iterations:y,boundaryHit:null,evaluation:E};E.p50>=o?p=R:A=R+1}return{recommendedFireMonth:w,p50TerminalAssets:d.p50,successRate:d.successRate,iterations:y,boundaryHit:null,evaluation:d}}function St({dependentBirthDate:t,dependentBirthDates:e}){const n=t?[t]:[];return e&&e.length>0?e:n}function It({simulationLimit:t,monthlyExp:e,monthlyInflationRate:n,simulationStartDate:s,mortgageMonthlyPayment:o,mortgagePayoffDate:i,lifestyleReductionFactor:l,independenceMonthKeys:r,householdChildrenCount:m,postFireExtraExpense:c}){const a=[],f=[];for(let u=0;u<=t;u++){const h=yt({baseMonthlyExpense:e,monthlyInflationRate:n,monthIndex:u,simulationStartDate:s,mortgageMonthlyPayment:o,mortgagePayoffDate:i,lifestyleReductionFactor:l,independenceMonthKeys:r,householdChildrenCount:m}),M=c*Math.pow(1+n,u);a.push(h),f.push(M)}return{precalculatedBaseExpenses:a,precalculatedExtraExpenses:f}}function lt({neededNetAmount:t,currentRisk:e,currentCostBasis:n,includeTax:s,taxRate:o}){const i=e>0?Math.max(0,(e-n)/e):0,r=1-(s?i*o:0),m=Math.max(0,e*r),c=Math.min(t,m),a=c/r,f=a*(1-i),u=Math.max(0,n-f),h=Math.max(0,e-a);return{actualNetFromRisk:c,grossFromRisk:a,nextCostBasis:u,nextRisk:h}}function Pt(t,e){const n=[];for(let s=0;s<=t;s++)n.push(e);return n}function z(t,e){if(t.length===1)return t[0];const n=e/100*(t.length-1),s=Math.floor(n),o=Math.ceil(n);if(s===o)return t[s];const i=n-s;return t[s]+(t[o]-t[s])*i}self.onmessage=t=>{const{simulationParams:e,options:n}=t.data;try{const s=Dt(e,n);self.postMessage({type:"success",result:s})}catch(s){self.postMessage({type:"error",error:s.message})}}})();
