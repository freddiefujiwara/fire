(function(){"use strict";const ot={userStartAge:65,spouseUserAgeStart:65,basicFullAnnualYen:78e4,basicReduction:.9,earlyReduction:void 0,pensionDataAge:44,userKoseiAccruedAtDataAgeAnnualYen:1e6,userKoseiFutureFactorAnnualYenPerYear:42e3,includeSpouse:!0};function gt(t){const e=Number(t);if(!Number.isFinite(e)||e===65)return 1;if(e<65){const o=Math.max(0,Math.round((65-e)*12));return Math.max(0,1-o*.004)}const n=Math.min(e,75);return 1+Math.max(0,Math.round((n-65)*12))*.007}function at(t,e,n=ot){let s=0;const{userStartAge:o,spouseUserAgeStart:r,basicFullAnnualYen:l,basicReduction:a,earlyReduction:c,pensionDataAge:u,userKoseiAccruedAtDataAgeAnnualYen:i,userKoseiFutureFactorAnnualYenPerYear:f,includeSpouse:h}=n,m=c??gt(o);if(t>=o){const M=l*a*m,g=Math.min(60,e),A=Math.max(0,g-u),p=i+A*f;s+=M+p*m}return h&&t>=r&&(s+=l),Math.round(s/12)}const Y=12,O=100,At=80;function xt({monthlyReturn:t,monthlyInflation:e,remainingMonths:n,taxRate:s,includeTax:o,currentAgeInSimulation:r,includePension:l=!0,withdrawalRate:a=.04,pensionConfig:c,postFireFirstYearExtraExpense:u,m:i,precalculatedBaseExpenses:f,precalculatedExtraExpenses:h}){if(n<=0)return 0;const m=t,M=e,g=a/12,A=o?s:0;let p=0;for(let d=n-1;d>=0;d--){const b=r+d/12,y=l?at(b,r,c):0,w=f[i+d]+h[i+d];let R=0;d<12&&(R=u/12*Math.pow(1+M,i+d));const E=w+R,T=Math.max(0,E-y),_=p/(1+m)+T/(1-A),q=(p/(1+m)-y/(1-A))/(1-g/(1-A));p=Math.max(_,q)}return Math.max(0,p)}function rt(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`}function yt({baseMonthlyExpense:t,monthlyInflationRate:e,monthIndex:n,simulationStartDate:s,mortgageMonthlyPayment:o,mortgagePayoffDate:r,lifestyleReductionFactor:l=1,independenceMonthKey:a,independenceMonthKeys:c=[],householdChildrenCount:u=0}){const i=o||0,f=Math.max(0,t-i),h=new Date(s);h.setMonth(h.getMonth()+n);const m=rt(h),g=(c.length>0?c:a?[a]:[]).filter(d=>m>=d).length,A=Rt({householdChildrenCount:u,independentChildrenCount:g,lifestyleReductionFactor:l}),p=f*A*Math.pow(1+e,n);return!i||!r?p+i:m>r?p:p+i}function Rt({householdChildrenCount:t,independentChildrenCount:e,lifestyleReductionFactor:n}){return t<=1?e>0?n:1:t===2?[1,.85,.7][Math.min(e,2)]:[1,.9,.8,.65][Math.min(e,3)]}function Et(t=[],e=24){return Array.isArray(t)?t.map(n=>{const s=/^(\d{4})-(\d{2})-(\d{2})$/.exec(String(n??"").trim());if(!s)return null;const o=Number(s[1]),r=Number(s[2]),l=Number(s[3]),a=new Date(o,r-1,l);if(a.getFullYear()!==o||a.getMonth()!==r-1||a.getDate()!==l)return null;const c=new Date(o+e,3,1);return rt(c)}).filter(Boolean).sort():[]}function H(t){if(!t)return H({});const e=t.monthlyExpense??(t.monthlyExpenses?t.monthlyExpenses/12:0),n=Number(t.currentAge||40),s=Number(t.simulationEndAge??O),o=Math.max(At,Math.ceil(n)),r=Math.min(O,Math.max(o,Number.isFinite(s)?s:O));return{initialAssets:Number(t.initialAssets??0),riskAssets:Number(t.riskAssets??0),annualReturnRate:Number(t.annualReturnRate??0),monthlyExpense:Number(e),monthlyIncome:Number(t.monthlyIncome??0),currentAge:n,includeInflation:!!t.includeInflation,inflationRate:Number(t.inflationRate??.02),includeTax:!!t.includeTax,taxRate:Number(t.taxRate??.20315),withdrawalRate:Number(t.withdrawalRate??.04),mortgageMonthlyPayment:Number(t.mortgageMonthlyPayment??0),mortgagePayoffDate:t.mortgagePayoffDate||null,postFireExtraExpense:Number(t.postFireExtraExpense??0),postFireFirstYearExtraExpense:Number(t.postFireFirstYearExtraExpense??0),retirementLumpSumAtFire:Number(t.retirementLumpSumAtFire??5e6),includePension:!!t.includePension,monthlyInvestment:Number(t.monthlyInvestment??0),maxMonths:Number(t.maxMonths??1200),pensionConfig:t.pensionConfig||ot,dependentBirthDate:t.dependentBirthDate||null,dependentBirthDates:Array.isArray(t.dependentBirthDates)?t.dependentBirthDates.filter(Boolean).slice(0,3):t.dependentBirthDate?[t.dependentBirthDate]:[],independenceAge:t.independenceAge||24,householdType:t.householdType||"single",simulationEndAge:r}}function W(t,{recordMonthly:e=!1,fireMonth:n=-1,returnsArray:s=null,skipRequiredAssets:o=!1}={}){const{initialAssets:r,riskAssets:l,annualReturnRate:a,monthlyExpense:c,monthlyIncome:u,currentAge:i,maxMonths:f,includeInflation:h,inflationRate:m,includeTax:M,taxRate:g,withdrawalRate:A,mortgageMonthlyPayment:p,mortgagePayoffDate:d,postFireExtraExpense:b,postFireFirstYearExtraExpense:y,retirementLumpSumAtFire:w,includePension:R,monthlyInvestment:E,pensionConfig:T,dependentBirthDate:_,dependentBirthDates:q,independenceAge:$,householdType:U,simulationEndAge:F=O}=t,v=c,N=Math.pow(1+a,1/12)-1,P=Math.pow(1+(h?m:0),1/12)-1,S=(F-i)*Y,G=new Date,ct=St({dependentBirthDate:_,dependentBirthDates:q}),kt=Et(ct,$),Bt=U==="family"?ct.length:0;let D=l,K=l,I=r-l,k=n;const j=e?[]:null,ut=S,Yt=U==="family"?.8:1,{precalculatedBaseExpenses:ht,precalculatedExtraExpenses:mt}=It({simulationLimit:ut,monthlyExp:v,monthlyInflationRate:P,simulationStartDate:G,mortgageMonthlyPayment:p,mortgagePayoffDate:d,lifestyleReductionFactor:Yt,independenceMonthKeys:kt,householdChildrenCount:Bt,postFireExtraExpense:b});for(let x=0;x<=ut;x++){const et=i+x/12,Tt=Math.max(0,S-x);x===k&&(I+=w);let ft=0;k!==-1&&x>=k&&x<k+12&&(ft=y/12*Math.pow(1+P,x));const Mt=Math.max(0,I+D),J=k!==-1&&x>=k,_t=k===-1?F:i+k/12,dt=R?at(et,_t,T):0,pt=J?0:u,Q=ht[x]+(J?mt[x]:0)+ft,nt=pt+dt;if(e&&x<=f){const B=o?0:xt({monthlyReturn:N,monthlyInflation:P,remainingMonths:Tt,taxRate:g,includeTax:M,currentAgeInSimulation:et,includePension:R,withdrawalRate:A,pensionConfig:T,postFireFirstYearExtraExpense:y,m:x,precalculatedBaseExpenses:ht,precalculatedExtraExpenses:mt});j.push({month:x,age:et,assets:Mt,riskAssets:D,cashAssets:I,requiredAssets:B,isFire:J,income:pt,pension:dt,expenses:Q,investmentGain:0,withdrawal:0})}if(x===S)break;let X=0,Z=0,st=0;const Lt=s[x];if(J){const B=Mt*A/12,L=Math.max(0,Q-nt),V=Math.max(L,B),C=Math.min(I,V),qt=V-C,tt=lt({neededNetAmount:qt,currentRisk:D,currentCostBasis:K,includeTax:M,taxRate:g});D=tt.nextRisk,K=tt.nextCostBasis,I+=nt+tt.actualNetFromRisk-Q,X=C+tt.grossFromRisk}else{const B=nt-Q,L=I+B;if(L<0){const V=Math.abs(L),C=lt({neededNetAmount:V,currentRisk:D,currentCostBasis:K,includeTax:M,taxRate:g});D=C.nextRisk,K=C.nextCostBasis,I=L+C.actualNetFromRisk,X=C.actualNetFromRisk>0?C.grossFromRisk:0}else Z=Math.min(E,L),I=L-Z,D+=Z,K+=Z,X=0}if(st=D*Lt,D+=st,e&&x<=f){const B=j[j.length-1];B&&(B.investmentGain=st,B.withdrawal=X)}}const Ct=I+D>=0;return{fireReachedMonth:k,monthlyData:j,survived:Ct,finalAssets:I+D}}function Ft(t,e=null){const{currentAge:n,maxMonths:s,simulationEndAge:o}=t,r=Math.min(s,(o-n)*Y);let l=-1;for(let a=0;a<=r;a+=Y)if(W(t,{fireMonth:a,returnsArray:e}).survived){l=a;break}if(l!==-1){let a=Math.max(0,l-11),c=l;for(;a<=c;){const u=Math.floor((a+c)/2);W(t,{fireMonth:u,returnsArray:e}).survived?(l=u,c=u-1):a=u+1}}return l}function bt(t,e={}){const n=H(t),{forceFireMonth:s=null,returnsArray:o=null,recordMonthly:r=!1}=e;let l=o;if(!l){const{currentAge:c,annualReturnRate:u,simulationEndAge:i}=n,f=(i-c)*Y,h=Math.pow(1+u,1/12)-1;l=Pt(f,h)}let a=s;return a===null&&(a=Ft(n,l)),W(n,{recordMonthly:r,fireMonth:a,returnsArray:l})}function wt(t){return function(){let e=t+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function Nt(t){let e=0,n=0;for(;e===0;)e=t();for(;n===0;)n=t();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*n)}function it(t,{trials:e=1e3,annualVolatility:n=.15,seed:s=123,forceFireMonth:o=null}={}){const r=H(t),a=bt(r,{forceFireMonth:o}).fireReachedMonth,c=Math.max(1,Math.floor(Number(e)||0)),u=Math.max(0,Number.isFinite(n)?n:0),i=wt(s),{currentAge:f,annualReturnRate:h,simulationEndAge:m}=r,M=(m-f)*Y,g=h,A=u,p=Math.log(1+g)-.5*Math.log(1+Math.pow(A/(1+g),2)),d=Math.log(1+Math.pow(A/(1+g),2)),b=p/12,y=Math.sqrt(d/12),w=[],R=[];let E=0;const T=Math.ceil(M/Y);for(let F=0;F<c;F++){const v=[];for(let S=0;S<=M;S++){const G=b+y*Nt(i);v.push(Math.exp(G)-1)}const N=W(r,{fireMonth:a,returnsArray:v,recordMonthly:!0,skipRequiredAssets:!0});w.push(N.finalAssets),N.survived&&E++;const P=[];for(let S=0;S<=T;S++){const G=S*Y;G<N.monthlyData.length?P.push(N.monthlyData[G].assets):P.push(N.monthlyData[N.monthlyData.length-1].assets)}R.push(P)}w.sort((F,v)=>F-v);const _=F=>z(w,F),q=[],$=[],U=[];for(let F=0;F<=T;F++){const v=R.map(N=>N[F]).sort((N,P)=>N-P);q.push(z(v,10)),$.push(z(v,50)),U.push(z(v,90))}return{successRate:E/c,p10:_(10),p50:_(50),p90:_(90),p10Path:q,p50Path:$,p90Path:U,trials:c,fireReachedMonth:a}}function Dt(t,e){const n=H(t),{trials:s=1e3,annualVolatility:o=.15,seed:r=123,targetSuccessRate:l=.8,simulationEndAge:a=100,currentAge:c=40}=e,u=Math.min(.99,Math.max(.01,l)),i=Math.max(0,Math.floor((a-c)*12)),f={trials:s,annualVolatility:o,seed:r},h=A=>it(n,{...f,forceFireMonth:A});let m=i,M=h(m);if(M.successRate<u)m=-1;else{const A=h(0);if(A.successRate>=u)m=0,M=A;else{let p=0,d=i;for(;p<d;){const b=Math.floor((p+d)/2),y=h(b);y.successRate>=u?(d=b,M=y):p=b+1}m=p,M=h(m)}}const g=vt(n,{...f,targetTerminalAssets:0,toleranceYen:5e5,minFireMonth:0,maxFireMonth:i});return{...M,targetSuccessRate:u,recommendedFireMonth:m,recommendedFireAge:m===-1?null:Math.floor(c+m/12),terminalDepletionPlan:g}}function vt(t,{trials:e=1e3,annualVolatility:n=.15,seed:s=123,targetTerminalAssets:o=0,toleranceYen:r=1e5,minFireMonth:l=0,maxFireMonth:a=null,maxIterations:c=18}={}){const u=H(t),i=Math.max(0,Math.floor((u.simulationEndAge-u.currentAge)*Y)),f=Math.max(0,Math.floor(Number(l)||0)),h=Math.min(i,Math.max(f,Math.floor(Number(a??i)||i))),m=w=>it(u,{trials:e,annualVolatility:n,seed:s,forceFireMonth:w}),M=m(f);if(M.p50>=o-r)return{recommendedFireMonth:f,p50TerminalAssets:M.p50,successRate:M.successRate,iterations:1,boundaryHit:"low",evaluation:M};const g=m(h);if(g.p50<o-r)return{recommendedFireMonth:h,p50TerminalAssets:g.p50,successRate:g.successRate,iterations:2,boundaryHit:"high",evaluation:g};let A=f,p=h,d=g,b=h,y=2;for(let w=0;w<c;w++){const R=Math.floor((A+p)/2),E=m(R);if(y+=1,Math.abs(E.p50-o)<Math.abs(d.p50-o)&&(d=E,b=R),Math.abs(E.p50-o)<=r)return{recommendedFireMonth:R,p50TerminalAssets:E.p50,successRate:E.successRate,iterations:y,boundaryHit:null,evaluation:E};E.p50>=o?p=R:A=R+1}return{recommendedFireMonth:b,p50TerminalAssets:d.p50,successRate:d.successRate,iterations:y,boundaryHit:null,evaluation:d}}function St({dependentBirthDate:t,dependentBirthDates:e}){const n=t?[t]:[];return e&&e.length>0?e:n}function It({simulationLimit:t,monthlyExp:e,monthlyInflationRate:n,simulationStartDate:s,mortgageMonthlyPayment:o,mortgagePayoffDate:r,lifestyleReductionFactor:l,independenceMonthKeys:a,householdChildrenCount:c,postFireExtraExpense:u}){const i=[],f=[];for(let h=0;h<=t;h++){const m=yt({baseMonthlyExpense:e,monthlyInflationRate:n,monthIndex:h,simulationStartDate:s,mortgageMonthlyPayment:o,mortgagePayoffDate:r,lifestyleReductionFactor:l,independenceMonthKeys:a,householdChildrenCount:c}),M=u*Math.pow(1+n,h);i.push(m),f.push(M)}return{precalculatedBaseExpenses:i,precalculatedExtraExpenses:f}}function lt({neededNetAmount:t,currentRisk:e,currentCostBasis:n,includeTax:s,taxRate:o}){const r=e>0?Math.max(0,(e-n)/e):0,a=1-(s?r*o:0),c=Math.max(0,e*a),u=Math.min(t,c),i=u/a,f=i*(1-r),h=Math.max(0,n-f),m=Math.max(0,e-i);return{actualNetFromRisk:u,grossFromRisk:i,nextCostBasis:h,nextRisk:m}}function Pt(t,e){const n=[];for(let s=0;s<=t;s++)n.push(e);return n}function z(t,e){if(t.length===1)return t[0];const n=e/100*(t.length-1),s=Math.floor(n),o=Math.ceil(n);if(s===o)return t[s];const r=n-s;return t[s]+(t[o]-t[s])*r}self.onmessage=t=>{const{simulationParams:e,options:n}=t.data;try{const s=Dt(e,n);self.postMessage({type:"success",result:s})}catch(s){self.postMessage({type:"error",error:s.message})}}})();
